<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - Smart Home</title>
  <link rel="stylesheet" href="css/global.css" />
  <link rel="stylesheet" href="css/dashboard.css" />
</head>
<body>
  <div class="container">
    <header>
      <h2>Dashboard</h2>
      <button onclick="logout()">Logout</button>
    </header>
    <p>Welcome, <span id="displayName">User</span>!</p>
    
    <!-- Rooms Section -->
    <section id="rooms-section">
      <h3>Your Rooms</h3>
      <div id="rooms-container">
        <!-- Room cards (and nodes) will be dynamically loaded from Firebase -->
      </div>
      <div style="text-align: center;">
        <button id="add-room-btn">+ Add Room</button>
      </div>
    </section>
  </div>
  
  <script type="module" src="js/auth.js"></script>
  <script type="module">
    import { getDatabase, ref, onChildAdded, onChildRemoved, remove, push } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
    
    const auth = getAuth();
    const db = getDatabase();
    let currentUserUid = null;
    
    auth.onAuthStateChanged(user => {
      if (user) {
        currentUserUid = user.uid;
        // Load the user's username from Firebase and display it
        const profileRef = ref(db, "users/" + user.uid + "/profile");
        onChildAdded(profileRef, (snapshot) => {
          if (snapshot.key === "username") {
            document.getElementById("displayName").textContent = snapshot.val();
          }
        });
        loadRooms();
      } else {
        window.location.href = "login.html";
      }
    });
    
    // Dummy array of icon filenames for nodes
    const iconNames = [
      "cook.png", "kitchen.png", "sofa.png", "chair.png", "study.png",
      "bed.png", "lamp.png", "tv.png", "fan.png", "ac.png",
      "table.png", "window.png", "door.png", "book.png", "plant.png",
      "computer.png", "stove.png", "fridge.png", "oven.png", "microwave.png",
      "vacuum.png", "clock.png", "radio.png", "console.png", "shelf.png",
      "dining.png", "garage.png", "bath.png", "mirror.png", "curtain.png",
      "office.png", "podcast.png", "heater.png", "projector.png", "stereo.png",
      "printer.png", "router.png", "wireless.png", "basement.png", "attic.png",
      "porch.png", "balcony.png", "garden.png", "entry.png", "lobby.png"
    ];
    
    const roomsContainer = document.getElementById("rooms-container");
    const addRoomBtn = document.getElementById("add-room-btn");
    
    function loadRooms() {
      const roomsRef = ref(db, "users/" + currentUserUid + "/rooms");
      onChildAdded(roomsRef, (snapshot) => {
        const roomData = snapshot.val();
        const roomKey = snapshot.key;
        createRoomCard(roomKey, roomData);
      });
      onChildRemoved(roomsRef, (snapshot) => {
        const roomKey = snapshot.key;
        const roomCard = document.getElementById("room-" + roomKey);
        if (roomCard) roomCard.remove();
      });
    }
    
    function createRoomCard(roomKey, roomData) {
      const roomCard = document.createElement("div");
      roomCard.classList.add("room-card");
      roomCard.id = "room-" + roomKey;
      
      const header = document.createElement("h3");
      header.textContent = roomData.name;
      roomCard.appendChild(header);
      
      // Right-click to delete room
      roomCard.addEventListener("contextmenu", function(e) {
        e.preventDefault();
        if (confirm("Delete room '" + roomData.name + "'?")) {
          remove(ref(db, "users/" + currentUserUid + "/rooms/" + roomKey));
        }
      });
      
      const nodesContainer = document.createElement("div");
      nodesContainer.classList.add("nodes-container");
      roomCard.appendChild(nodesContainer);
      
      const roomNodesRef = ref(db, "users/" + currentUserUid + "/rooms/" + roomKey + "/nodes");
      onChildAdded(roomNodesRef, (snapshot) => {
        const nodeData = snapshot.val();
        const nodeKey = snapshot.key;
        addNodeItem(nodesContainer, roomKey, nodeKey, nodeData);
      });
      onChildRemoved(roomNodesRef, (snapshot) => {
        const nodeKey = snapshot.key;
        const nodeElem = document.getElementById("node-" + roomKey + "-" + nodeKey);
        if (nodeElem) nodeElem.remove();
      });
      
      const addNodeBtn = document.createElement("button");
      addNodeBtn.classList.add("add-node");
      addNodeBtn.textContent = "+ Add Node";
      addNodeBtn.onclick = function() {
        addNodeToRoom(roomKey);
      };
      roomCard.appendChild(addNodeBtn);
      
      roomsContainer.appendChild(roomCard);
    }
    
    function addNodeItem(container, roomKey, nodeKey, nodeData) {
      const nodeItem = document.createElement("div");
      nodeItem.classList.add("node-item");
      nodeItem.id = "node-" + roomKey + "-" + nodeKey;
      
      const iconImg = document.createElement("img");
      iconImg.src = "assets/images/" + nodeData.icon;
      iconImg.alt = nodeData.name;
      nodeItem.appendChild(iconImg);
      
      const nodeLabel = document.createElement("span");
      nodeLabel.textContent = nodeData.name;
      nodeItem.appendChild(nodeLabel);
      
      nodeItem.addEventListener("contextmenu", function(e) {
        e.preventDefault();
        if (confirm("Delete node '" + nodeData.name + "'?")) {
          remove(ref(db, "users/" + currentUserUid + "/rooms/" + roomKey + "/nodes/" + nodeKey));
        }
      });
      
      container.appendChild(nodeItem);
    }
    
    addRoomBtn.addEventListener("click", function() {
      const roomName = prompt("Enter Room Name:");
      if (roomName) {
        push(ref(db, "users/" + currentUserUid + "/rooms"), { name: roomName });
      }
    });
    
    function addNodeToRoom(roomKey) {
      const nodeName = prompt("Enter node name:");
      if (!nodeName) return;
      let iconChoice = prompt("Enter icon name (e.g., kitchen.png):\nOptions: " + iconNames.join(", "));
      if (!iconNames.includes(iconChoice)) {
        alert("Icon not available. Using default icon (lamp.png).");
        iconChoice = "lamp.png";
      }
      push(ref(db, "users/" + currentUserUid + "/rooms/" + roomKey + "/nodes"), { name: nodeName, icon: iconChoice });
    }
  </script>
</body>
</html>
